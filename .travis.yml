language: java
jdk:
  - openjdk8
services:
  - docker

# env:
#   global:
#     secure: IMAGE_NAME
#     secure: HEROKU_API_KEY
#     secure: DOCKER_USER
#     secure: DOCKER_PASS
#     secure: TEAMS_CHANNEL_URL

# replace the following env configurations with your own
env:
  global:
    - secure: WNtr7AOjuviWuCH/LLtKGjp5zcPCC6M2tgBq00h0Cc72hQN4CtOxsI4XTvH4DsD3ORfDSNoGphFieVjVqEuUGcjWAwpAyhkQkClJ0I/wYGTiKrXFveDtFpV9i6NxonmuARDaomdUX0CgprWF8nIKZcJhjy47Ph6C4ulQ7rhpbAdX4dbuc/wV8YMY25iqE/83TQF44GyZiD9/FX52ZaV3zF7mfWfH2IlKiiNxqpaJlxXIEK7WIsWvA4KpbWl/7LuONKVLJxcCaf9F4ZzliW6A35SOlBDYLpXVpGn+aZAOQ2tW5Brp3S/WCuwDNiXU1O6mKQM+URTg1NgdAX+m16E9y8bmKpxkyKsXs6vOSPyZYRO4zHBED/nanLpjkBgf5EPjBhh0FDZtlfewDe0sM+A2yDp7HilkUFkvZqdxdse/Eb4STvLXmtecTc5VBPKsE0R6Gn0TcoCGH0B7Rc9QSrSDdZhBUkAWsYfLS6d7UgzWpCozQKqYAjmcGvaYep6PK0/qSTXu0brjtMS4AucyWyYhs/y6WzCpPoyQrFUeoHmuCCMJ/FC0W0VT/p4O0wtLiqbLQO8YBzReOmPJiLPwZwGIFq32Jxt5KfRZKs+JQ4QEP4AR5XsMNOtAu480wE/NM5BBUr2ZHJA5PvYrtcJimGZCyl9Nwva7HvMnRY5WgiHNShM=
    - secure: m8ghn81FHv/PC+TqIW9F0B7WOcQ3EP/jaXNB40QwM5mJoDhFPMA86V8ln1paJnVLfifU47SGeMd4/CjWUWweKn90eB1EoTm767URCpOBUg4OXePbO2M6YFSEyweUTqjZEltnhnB55YPmq6JFOLgDsuDRcAZeN4+hSoUBHxiT/tNWbqgH8/BqWbfP52O3EmOqmdYD5Y9F2HyYaFvAhcqY+M1jeaq59kxGSHB5NWQYkQYhHCiyp8qiDu3XN7MoGRfl+eRs+i6zKOY5J8PlLj/vrKoTzq4wlY/EO3JZJiRzDOav8V0wnMNSbm6YzBqy1IpCZZlrCAh0cTVQeQgHkvF/McChZljBUAver1cj/8FvohFPtUNnTyI20L25G0tX8SBNZ6IJ7/TQVXqSkhRJWspoTTqfxtaaqdpxdeO+m+OoHegqHt5K6VNxNpzRHqvQhdFUwmytiAzp4RFPmREQj7ZbUuiUa0pLOEtFlihr736p00qs5ETSTwAxhs/AbIMfbIJLCRmkTHBw+lCf8jEUpWTESiXnkWzA0Kcwo/KjMwbxNU/4QUDIjgA04fjsGmWF9+/abb7kDh9YPJxTxWEMdtwhUDAzxOpkqvG2W4dmw1R7bSNmakGuUVQEbRwQIsD6HuZ95zyT7L91h453gUlcnO2xCpewrfijoT1SJlVQk1/6p5s=
    - secure: sSwQpT3KD9OgTBhzCo7ESLX7YKesa/wan1G+1odv2PMr0zb6GhREbOhgnMZP7olP6VleWF0h5EUE/Prm+qFeG4kSKiusmuRB3lRGjAbeRaQ41Ti57L61zQ8rUVm7Di57+AsSpt4iqxX68PDO3xncrPu0V237/u4R5FJp1GrY4L8WdHkqUoAsaIIznOjZjVdF2SObTQb4pd+q6XS+oByH1ZBB/fPrG62++Aya7TV1DsaiyNjE3R6TDnrVFSZD0+0+FALxdFHyHXZrfXsT5iEJgMyqLUTmbzXnqaZE1S6Qi/N5+tjYhdmIckIM9MixGJ9hHiXCy9GBqqKZr8Ybgm0+1FIHp6sgiUj2xFRZ5i2g4QbPoZwF9L9mzhyrIGOioqNRd2zL6bY2mIAWJnAbomekJdoiS9U1p+0b9tlkjaGuZr3P0fPRa2PTYK1C9neLhXxNGSH7rvTQ6kLv4guc3dPUZyJMbJcneWzt5AsWXabntuyYRWd3GOQZDJiQKF22bhPoOjSjL7QhjqPY4/vQc4zq8G6X1wLMuYIItNy2JB9jczjE1yNFVE9cPU7MYeEcyhhwO41rT874tavUAIcmWANDojP983kCs0Pc+p8GXgBZJ7jysqT3LVDt0zL1MrOaJJ3Ml1353EBRVZmclTqoPxg4q0eH9VU+N4n9SMaK3gSjJzk=
    - secure: qD0ZbERBvxFpkzhi5mAN+Eh8M/VILPNh8Bfxa/XGCnjC1du1WpjIQ9dTdXGb5FC9QgcJcK2P+j2rI4klU/f4khB7rueWg6sPhCP/g5qVIcBVvvHIIVIGo9JMyfl3Q9PoSk7Mt/4J/h3l9H5dyUzsYZ5yvVbjTS89qjokYtYMmoBc/pidEgr6t0WXApyFBg3NK47SZ61AuctIypAfg2ue9VQmOBZomHm4Hwx46ivjgtFzsNuBmH4Hsa3BPRuk6Iudbfzckh3k/dojXnDthVxI+VPWSnc5C+UEwCXsPjp7+8vvoLrhfklQsih4ZMob1Xq8PGhAvZrwMMpTD4qMaBhwHetA60UKTA7gogDb//AtR7OEnKXHkpyrMRwNk+dokxvGiXPMZVBKLM2LQ8HQ9Llwyl7Ly5HAU5VsRbIunb+bA8RVf7mInpEz19vNBT8BmDuAGvoahHvKbg5EjulBow1EhKyVZZqBL3Ubw9Ya/GlXjYjX06oEgAAsIC3RBe8QcSTy2CrJ23b2Kqp3ZAXZeNz/KxZnISHpk0WK/agxSWaSVU3Hcd48gGBtFDb93zyFxqW0ZyUfja/qNLTOhljQtzbCOEXOBQpZfR2gBO+IVCkVsv+BUP6O0MGSRub5kCsPH1Y4bVjGal1fp8ZBNfJlVaOGr4o7EhGlPAyINq3ZgF7SAUM=
    - secure: nDQrkDZRoapc6MJ40cz8LzpeXpFOCh0e9mN8lKn6y1gJgNK17v/WkZrfzEqPIIhjf4YVPD3YNpUMY1BiunFkINRHZaak7yH8izV6cRMmH7gXcnv549/tVHWJdVopPwHvnPkzzI6PHb0cUEblxn5IDQgnqdYNRXHsujdQbnx9JnxcvFhpb0G+eVPnukKd3HN5viHz1KI3/AyhhI1LxWtfLYNjR+yluv9c40Bq7ojef1gb5Mub8MLqyz+ftc2yUEQK0SMPMZc7aMsXf9qG6IEXnDvk5YtkkVLeXoYOWWeT+gsmoiRYzF6paEeL1fuuJBg6OcHjPw7M8Lp8kxnVbPijXNV5VTrJj/eVh9Lk6esCTRZg1UhV0VPr4dNqYcb/PuXorBQXvAwcROhWFlVzJ/Z9BoqjuBfojdjdZxJT9ouayzHalGowYTRHA95kR0Qd3K/K00HGEEMaJcR44nMS9eMLFnXaYJABvnlRu2ahXDNx069NNfbwzfPlx3CntwS8AVWDcDLi/fzeOe4tbV2ROtZR5mLOBjAuPcGZPH6etiRtg7ucA/5sBH5WTwkDEKWlNWbYK7wgV2uMPTLs8tBecTU6t+Ab7fPI0VJm4xJy/WhGV5kegCAJ9J5Gi7JIGUpw5NVsfzN0WAz6ffmnlW1b6QNkeoo2mK3n7hDCQXPsxjykDLc=

before_install:
  - docker pull openjdk:8-jdk-alpine

# Test & Build SpringBoot app
script:
  - mvn test
  - mvn clean package

# Create Docker image for our app and push it to Dockerhub repository and send messages to the Teams channel after the `script` job is successfully executed
after_success:
  - export COMMIT=${TRAVIS_COMMIT::7}
  - export TAG=`if [ ! -z "$TRAVIS_TAG" ]; then echo "$TRAVIS_TAG"; else echo "$TRAVIS_BRANCH--$COMMIT"; fi`
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - docker-compose build
  - docker tag $IMAGE_NAME:latest $IMAGE_NAME:$TAG
  - docker push $IMAGE_NAME:$TAG
  - export TITLE="$IMAGE_NAME:$TAG is built properly and pushed to Dockerhub"
  - export TIMESTAMP=`date`
  - export GIT_LOG=`git log -1 --pretty=%B $COMMIT`
  - export TEXT="[build version] $TAG<br />[datetime] $TIMESTAMP<br />[changelog] $GIT_LOG<br />"
  - chmod +x send_to_teams.sh && ./send_to_teams.sh

# If the `script` job fails, it will send a failure message to Teams channel
after_failure:
  - export TITLE="Travis:$TRAVIS_JOB_ID -- build job is failed"
  - export TEXT=[datetime]:`date`

# Allow Travis to help deploy the app on Heroku
deploy:
  provider: heroku
  api-key:
    secure: "$HEROKU_API_KEY"
  app: my-springboot-helloworld
  on:
    tags: true
    repo: "$IMAGE_NAME"

# Send the message of success after the deploy is done properly
after_deploy:
  - export TITLE="ðŸŽ‰ðŸŽ‰ðŸŽ‰New version $TAG is deployed to Heroku productionðŸŽ‰ðŸŽ‰ðŸŽ‰"
  - export TEXT=[datetime]:`date`
